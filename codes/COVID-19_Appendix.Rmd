---
title: "COVID-19 Analysis Appendix"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Scaling
```{r}
df %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~key, scales = "free") +
  geom_histogram(binwidth = 30)+
  theme_bw() + 
  scale_fill_wsj()
```


## Modeling

1, Level - level regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = cases_ppc, y = deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Cases per 10'000 people",y = "Deaths per 10'000 people")
```

2, Log - level regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = ln_cases_ppc, y = deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Cases per 10'000 people)",y = "Deaths per 10'000 people")
```

3, Level - log regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = cases_ppc, y = ln_deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Cases per 10'000 people",y = "ln (Deaths per 10'000 people)")
```

4, Log - log regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = ln_cases_ppc, y = ln_deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

## Regression Models
Different models:
    reg1: ln_deaths_ppc = alpha + beta * ln_cases_ppc
    reg2: ln_deaths_ppc = alpha + beta_1 * ln_cases_ppc + beta_2 * ln_cases_ppc^2
    reg3: ln_deaths_ppc = alpha + beta_1 * ln_cases_ppc * 1(ln_cases_ppc < 50) +                beta_2 * ln_cases_ppc * 1(ln_cases_ppc >= 50)
    reg4: ln_deaths_ppc = alpha + beta * ln_cases_ppc, weights: population

First I will add the square and cube of the x variable to df
```{r}
df <- df %>% mutate( ln_cases_ppc_sq = ln_cases_ppc^2)
```

# Regression 1 - Simple linear regression
```{r}
reg1 <- lm_robust( ln_deaths_ppc ~ ln_cases_ppc , data = df,  se_type = "HC2" )
summary( reg1 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regression 2 - Quadratic (linear) regression
```{r}
reg2 <- lm_robust( ln_deaths_ppc ~ ln_cases_ppc + ln_cases_ppc_sq , data = df )
summary( reg2 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ poly(x,2) , method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regressipn 3 - Piecewise linear spline regression

First we create a cut off point and trasnform it into a log
```{r}
cutoff <- 50
cutoff_ln<- log( cutoff )

reg3 <- lm_robust(ln_deaths_ppc ~ lspline( ln_cases_ppc , cutoff_ln ), data = df )
summary( reg3 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ lspline(x,cutoff_ln) , method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regression 4 - Weighted linear regression, using population as weights
```{r}
reg4 <- lm_robust(ln_deaths_ppc ~ ln_cases_ppc, data = df , weights = population)
summary( reg4 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot(data = df, aes(x = ln_cases_ppc, y = ln_deaths_ppc)) +
  geom_point(data = df, aes(size=population),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = population), method = "lm", color='red')+
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

## Comparing models
```{r}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_1/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 ),
         type = 'html',
         custom.model.names = c("ln(Cases per 10'000) - linear","ln(Cases per 10'000) - quadratic",
                                "ln(Cases per 10'000) - PLS",
                                "ln(Cases per 10'000) - weighted linear"),
         caption = "Modelling registered cases and registered deaths of COVID-19 in different countries",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

Pick Weighted OLS

