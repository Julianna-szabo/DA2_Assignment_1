---
title: "COVID-19 Analysis Appendix"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Appendix 1 - Looking at the data
```{r}
df %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~key, scales = "free") +
  geom_histogram(binwidth = 30)+
  theme_bw() + 
  scale_fill_wsj()
```
```{r, echo = FALSE, fig.asp=0.30, include=FALSE}

summary_confirmed <- df %>% 
  summarise(
    variable = 'confirmed',
    mean = mean(confirmed, na.rm = TRUE),
    median = median(confirmed, na.rm = TRUE),
    min = min(confirmed, na.rm = TRUE),
    max = max(confirmed, na.rm = TRUE),
    sd = sd(confirmed, na.rm = TRUE)
    )

summary_death <- df %>% 
  summarise(
    variable = 'death',
    mean = mean(death, na.rm = TRUE),
    median = median(death, na.rm = TRUE),
    min = min(death, na.rm = TRUE),
    max = max(death, na.rm = TRUE),
    sd = sd(death, na.rm = TRUE)
  )

summary_recovered <- df %>% 
  summarise(
    variable = 'recovered',
    mean = mean(recovered, na.rm = TRUE),
    median = median(recovered, na.rm = TRUE),
    min = min(recovered, na.rm = TRUE),
    max = max(recovered, na.rm = TRUE),
    sd = sd(recovered, na.rm = TRUE)
  )

summary_active <- df %>% 
  summarise(
    variable = 'active',
    mean = mean(df$active, na.rm = TRUE),
    median = median(active, na.rm = TRUE),
    min = min(active, na.rm = TRUE),
    max = max(active, na.rm = TRUE),
    sd = sd(active, na.rm = TRUE)
  )

summary_population <- df %>% 
  summarise(
    variable = 'population',
    mean = mean(population, na.rm = TRUE),
    median = median(population, na.rm = TRUE),
    min = min(population, na.rm = TRUE),
    max = max(population, na.rm = TRUE),
    sd = sd(population, na.rm = TRUE)
  )

summary_df <- rbind(summary_confirmed, summary_death, summary_recovered, summary_active, summary_population)
kable(summary_df)
```

# Appendix 2 - Modeling

1, Level - level regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = cases_ppc, y = deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Cases per 10'000 people",y = "Deaths per 10'000 people")
```

2, Log - level regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = ln_cases_ppc, y = deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Cases per 10'000 people)",y = "Deaths per 10'000 people")
```

3, Level - log regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = cases_ppc, y = ln_deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "Cases per 10'000 people",y = "ln (Deaths per 10'000 people)")
```

4, Log - log regression
```{r, echo = FALSE}
df %>% 
  ggplot(aes(x = ln_cases_ppc, y = ln_deaths_ppc)) +
  geom_point() +
  geom_smooth(method="loess")+
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Apendix 3 - Regression Models
Different models:
    reg1: ln_deaths_ppc = alpha + beta * ln_cases_ppc
    reg2: ln_deaths_ppc = alpha + beta_1 * ln_cases_ppc + beta_2 * ln_cases_ppc^2
    reg3: ln_deaths_ppc = alpha + beta_1 * ln_cases_ppc * 1(ln_cases_ppc < 50) +                beta_2 * ln_cases_ppc * 1(ln_cases_ppc >= 50)
    reg4: ln_deaths_ppc = alpha + beta * ln_cases_ppc, weights: population

First I will add the square and cube of the x variable to df
```{r}
df <- df %>% mutate( ln_cases_ppc_sq = ln_cases_ppc^2)
```

# Regression 1 - Simple linear regression
```{r}
reg1 <- lm_robust( ln_deaths_ppc ~ ln_cases_ppc , data = df,  se_type = "HC2" )
summary( reg1 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regression 2 - Quadratic (linear) regression
```{r}
reg2 <- lm_robust( ln_deaths_ppc ~ ln_cases_ppc + ln_cases_ppc_sq , data = df )
summary( reg2 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ poly(x,2) , method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regressipn 3 - Piecewise linear spline regression

First we create a cut off point and trasnform it into a log
```{r}
cutoff <- 50
cutoff_ln<- log( cutoff )

reg3 <- lm_robust(ln_deaths_ppc ~ lspline( ln_cases_ppc , cutoff_ln ), data = df )
summary( reg3 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot( data = df, aes( x = ln_cases_ppc, y = ln_deaths_ppc ) ) + 
  geom_point( color='blue') +
  geom_smooth( formula = y ~ lspline(x,cutoff_ln) , method = lm , color = 'red' ) +
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

# Regression 4 - Weighted linear regression, using population as weights
```{r}
reg4 <- lm_robust(ln_deaths_ppc ~ ln_cases_ppc, data = df , weights = population)
summary( reg4 )
```
```{r, echo = FALSE, warning=FALSE}
ggplot(data = df, aes(x = ln_cases_ppc, y = ln_deaths_ppc)) +
  geom_point(data = df, aes(size=population),  color = 'blue', shape = 16, alpha = 0.6,  show.legend=F) +
  geom_smooth(aes(weight = population), method = "lm", color='red')+
  labs(x = "ln (Cases per 10'000 people)",y = "ln (Deaths per 10'000 people)")
```

## Comparing models
```{r}
data_out <- "/Users/Terez/OneDrive - Central European University/Data_Analysis_02/DA2_Assignment_1/out/"
htmlreg( list(reg1 , reg2 , reg3 , reg4 ),
         type = 'html',
         custom.model.names = c("ln(Cases per 10'000) - linear","ln(Cases per 10'000) - quadratic",
                                "ln(Cases per 10'000) - PLS",
                                "ln(Cases per 10'000) - weighted linear"),
         caption = "Modelling registered cases and registered deaths of COVID-19 in different countries",
         file = paste0( data_out ,'model_comparison.html'), include.ci = FALSE)
```

On the table, it is clear to see that all four of these models fit well to the data. In the linear model we have an alpha of -3.74 and a beta of 0.94. Both of these values have a very low p-value of less than 0.1. The model also has a good RÂ°2 value at .79. These numbers do not change significantly for the quadratic or the PLS model either, which have an apha of -3.71 and -3.77 respectively. In the quardatic, one can see that the sqared term has almost no impact on the line since it's coefficient is only 0.01. The PLS also does not change the line-of-best-fit much since the slopes of the two lines are relatively close togehter.
While the alpha and beta also do not change significantly for the Weighted linear regression the R^2 increases from 0.79 for all the other models to 0.9.


Reasons for picking Weighted linear regression
Substansive: Since more people usually means more cases, it makes sense to add                     population as a weight, even with per capita numbers. Especially in                 his case, some large counties who are doing great could be gives                   more weight than some small country that is doing very bad.
Statistical: The weighted linear regression has the best R^2 of the four models.                   Further its coefficients are similar to the other regressions and                  have very small p-values (under 0.01).
